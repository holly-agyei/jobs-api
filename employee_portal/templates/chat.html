{% extends "base.html" %}
{% block title %}Messages - Employee Portal{% endblock %}
{% block head_extra %}
<meta name="socket-room" content="{{ room or '' }}">
<meta name="socket-user" content="{{ current_user.id }}">
<meta name="socket-target" content="{{ selected_user.id if selected_user else '' }}">
{% endblock %}
{% block content %}
<div class="chat-shell">
    <aside class="chat-sidebar card shadow-sm">
        <div class="sidebar-header d-flex justify-content-between align-items-center">
            <div>
                <p class="text-muted small mb-0">Connections</p>
                <h2 class="h5 mb-0">{{ connection_count }} Members</h2>
            </div>
            <a href="{{ url_for('connections.manage_connections') }}" class="btn btn-sm btn-outline-secondary">Manage</a>
        </div>
        <div class="sidebar-list">
            {% if users %}
                {% for user in users %}
                <a href="{{ url_for('chat.chat_home', user_id=user.id) }}"
                   class="sidebar-item {% if selected_user and user.id == selected_user.id %}is-active{% endif %}">
                    <div class="avatar-circle small">
                        {% if user.profile and user.profile.photo_filename %}
                            <img src="{{ url_for('static', filename='uploads/' + user.profile.photo_filename) }}" alt="Profile Photo" class="avatar-img">
                        {% else %}
                            {{ user.username[0]|upper }}
                        {% endif %}
                    </div>
                    <div>
                        <p class="mb-0 fw-semibold">{{ user.username }}</p>
                        <small class="text-muted">{{ user.profile.headline if user.profile else 'No headline' }}</small>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state text-center text-muted p-4">
                    <p class="mb-2">No connections yet.</p>
                    <a href="{{ url_for('connections.manage_connections') }}" class="btn btn-outline-primary btn-sm">Find teammates</a>
                </div>
            {% endif %}
        </div>
    </aside>

    <section class="chat-window card shadow-sm">
        {% if selected_user %}
        <div class="conversation-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="avatar-circle medium">
                    {% if selected_user.profile and selected_user.profile.photo_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + selected_user.profile.photo_filename) }}" alt="Profile Photo" class="avatar-img">
                    {% else %}
                        {{ selected_user.username[0]|upper }}
                    {% endif %}
                </div>
                <div>
                    <h1 class="h5 mb-0">{{ selected_user.username }}</h1>
                    <p class="text-muted small mb-0">{{ selected_user.profile.headline if selected_user.profile else 'No headline available' }}</p>
                </div>
            </div>
            <div class="conversation-tools">
                <span class="icon">üîç</span>
                <span class="icon">‚öôÔ∏è</span>
            </div>
        </div>

        <div id="chat-messages" class="conversation-body">
            {% if messages %}
                {% for message in messages %}
                <div class="message-row {% if message.sender_id == current_user.id %}is-outgoing{% endif %}">
                    <div class="message-card">
                        <p class="mb-1">{{ message.content }}</p>
                        <small class="text-muted">{{ message.created_at.strftime("%b %d, %H:%M") }}</small>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="conversation-placeholder text-center text-muted">
                    <p>No messages yet. Say hello to start the conversation.</p>
                </div>
            {% endif %}
        </div>

        <form id="chat-form" method="post" class="conversation-input">
            {{ form.hidden_tag() }}
            {{ form.content(class="form-control", placeholder="Type your message...") }}
            <button class="btn btn-dark" type="submit">{{ form.submit.label.text }}</button>
        </form>
        {% else %}
        <div class="conversation-placeholder text-center text-muted">
            <div class="avatar-circle giant mb-3">{{ current_user.username[0]|upper }}</div>
            <p class="lead mb-2">Select a connection to start messaging</p>
            <p class="text-muted">Your accepted connections appear on the left.</p>
            <a href="{{ url_for('connections.manage_connections') }}" class="btn btn-outline-primary mt-3">Find Connections</a>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}
{% block body_extra %}
{% if selected_user %}
<script>
    window.chatConfig = {
        room: "{{ room }}",
        senderId: {{ current_user.id }},
        receiverId: {{ selected_user.id }},
    };
</script>
{% endif %}
{% endblock %}
